{% extends 'newbase.html' %}

{% block title %}
  {{ super() }}
  Test
{% endblock %}

{% block content %}

<div class='container'>
  <div class='row' id='title'>
    <h1>Multiple boards in grid</h1>
  </div>
  <div class='row' id='grid'>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

<script src="{{ url_for('static', filename='js/jcanvas.min.js') }}"></script>

<script>

var boardDiv = $('<div>').attr('class', 'col-xs-12 col-sm-4 col-md-3 col-lg-2').attr('style', 'background-color:pink').append($('<canvas>').attr('width', '400').attr('height', '400'),
$('<h4>').attr('style', 'text-align:left'));

var colours = [
    "#E1E1E1", // 0 - empty
    "#FFFFFF", // 1 - white
    "#D0011B", // 2 - red
    "#7ED321", // 3 - light green
    "#BD0FE1", // 4 - purple
    "#F7E500", // 5 - yellow
    "#417505", // 6 - dark green
    "#4A4A4A", // 7 - black
    "#8B572A", // 8 - brown
    "#4990E2", // 9 - blue
    "#F6A623" // 10 - orange
  ];

var temp = '';

function drawBoard(canvas, id, rods) {

  var canvasSize = canvas.width;
  var boardSize = canvasSize * 0.9;

  $(canvas).drawRect({
    layer: true,
    name: String('board_' + id),
    x: canvasSize / 2,
    y: canvasSize / 2,
    height: boardSize * 1.1,
    width: boardSize * 1.1,
    cornerRadius: boardSize / 25,
    fillStyle: "#E2E2E2",
    fromCenter: true
  });

  for (var row in rods) {
   var column = 0;
   while (column < 9) {
     //console.log('column ' + column);
     var value = parseInt(rods[row][column], 10);
     //console.log('cell value: ' + value);
     if (value === 0) {
       column = column + 1;
       //console.log('empty cell');
     } else {
       //console.log("adding rod " + value + " to board " + id);
       // Draw rod
       $(canvas).drawRect({
         layer: true,
         name: String("rod_" + value),
         //groups: ["rods"],
         x: canvasSize * 0.05 + boardSize / 10 * column,
         y: canvasSize * 0.05 + boardSize / 10 * row,
         height: boardSize / 10,
         width: boardSize * value / 10,
         fillStyle: $(colours)[value],
         strokeStyle: "#E1E1E1",
         strokeWidth: boardSize / 100,
         cornerRadius: boardSize / 50,
         fromCenter: false
       });
       column = column + value;
     }
   }
 }


}

function pollBoard() {
  $.ajax({
           type: "GET",
           url: "/api/classrooms/{{current_user.classroom_id}}",
           data: '',
           contentType: "application/json; charset=utf-8",
           dataType: "json",
           username: 'smartrods',
           password: 'fae2ba5c-7a51-407b-9c0a-1366ce610ff1',
           success: function (result) { console.log(result); },
           error: function (error) { console.log(error); }
  })
    .done(function(data) {
      temp = data;
      $('#grid').empty();
      for (i in data) {

        var board = $(boardDiv).clone();
        var canvas = $(board).find('canvas');

        canvas.attr('id', String('board_' + data[i].id));
        canvas.attr('width', canvas.parent().width());
        canvas.attr('height', canvas.parent().width());

        $(board).find('h4').text(data[i].user);

        var input =  data[i].rods.replace(/{/g, "[").replace(/}/g, "]");
        var rods = JSON.parse("[" + input + "]")[0];

        drawBoard($(board).find('canvas')[0], data[i].id, rods);

        $('#grid').append(board);
      };
    })
    .always(function() {
      setTimeout(pollBoard, 5000);
    });
}

function respondCanvas() {
  var canvases = $('canvas');
  for (i in canvases) {
    var canvas = canvases[i];
    var container = $(canvas).parent();
    var size = $(container).width();
    $(canvas).attr('width', size);
    $(canvas).attr('height', size);
    drawBoard(canvas, temp[i].id, temp[i].rods);

  }
}

$(document).ready(function() {

  pollBoard();

  $(window).resize(respondCanvas);

});

</script>

{% endblock %}
